# name: Deploy To Google Play

# on:
#   push:
#     branches: [main]

# jobs:
#   build:
#     runs-on: ubuntu-latest

#     steps:
#       # 1️⃣ Checkout repo
#       - uses: actions/checkout@v4

#       # 2️⃣ Set up Flutter with caching
#       - name: Set up Flutter
#         uses: subosito/flutter-action@v2
#         with:
#           channel: stable
#           cache: true

#       # 3️⃣ Cache Pub packages for faster CI
#       - name: Cache Pub packages
#         uses: actions/cache@v3
#         with:
#           path: |
#             ~/.pub-cache
#             .dart_tool/pub
#           key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.yaml') }}

#       # 4️⃣ Install dependencies
#       - name: Install dependencies
#         run: flutter pub get

#       # 5️⃣ Run Flutter tests
#       - name: Run tests
#         run: flutter test

#       # 6️⃣ Set up JDK 17 for Android builds
#       - name: Set up JDK 17
#         uses: actions/setup-java@v4
#         with:
#           distribution: 'temurin'
#           java-version: 17
#           cache: gradle

#       # 8️⃣ Build Android App Bundle (AAB)
#       - name: Build Android App Bundle (AAB)
#         run: flutter build appbundle --release




name: Deploy To Google Play

on:
  push:
    branches: [main]

jobs:
  test:
    name: Unit Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
    
      - name: Install dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17
          cache: 'gradle'

  distribute:
    name: Distribute bundle to Google Play
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17
          cache: 'gradle'

      # - name: Version Bump
      #   uses: chkfung/android-version-actions@v1.2.3
      #   with:
      #     gradlePath: app/build.gradle
      #     versionCode: ${{ github.run_number }}

      - name: Build Android App Bundle (AAB)
        run: flutter build appbundle --release

      - name: Sign Release
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: build/app/outputs/bundle/release
          signingKeyBase64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          keyStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          alias: ${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}

      # - name: Deploy to Google Play
      #   uses: r0adkll/upload-google-play@v1
      #   with:
      #     serviceAccountJsonPlainText: ${{ secrets.PLAY_AUTH_JSON }}
      #     packageName: com.yourcompany.yourapp
      #     releaseFiles: build/app/outputs/bundle/release/app-release.aab
      #     track: production
      #     status: completed
